<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>QR Code Attendance Scanner</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="js/jsQR.min.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; }
    .container { max-width: 600px; padding: 1.5rem; margin: auto; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .button-active { background-color: #3b82f6; color: white; border-radius: 0.5rem; }
    .rounded-card { background-color: white; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); padding: 1.5rem; margin-bottom: 1.5rem; }
    .scanner-container { position: relative; width: 100%; height: 300px; background-color: black; border-radius: 1rem; overflow: hidden; }
    #video { width: 100%; height: 100%; object-fit: cover; }
    #canvas { display: none; }
    #loading-message { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 1.25rem; }
  </style>
</head>
<body class="p-4">
  <div class="container bg-gray-100 min-h-screen">
    <h1 class="text-3xl font-bold text-center text-blue-800 my-4">QR Attendance</h1>
    <p id="app-id-display" class="text-xs text-center text-gray-500 mb-4"></p>

    <!-- Tabs -->
    <div class="flex space-x-2 p-2 bg-gray-200 rounded-full mb-4">
      <button id="scan-tab-btn" class="flex-1 py-2 px-4 button-active">Scan</button>
      <button id="log-tab-btn" class="flex-1 py-2 px-4">Log</button>
    </div>

    <!-- Scan -->
    <div id="scan-tab" class="tab-content active">
      <div class="rounded-card text-center">
        <p id="date-display" class="text-sm font-medium text-blue-500"></p>
        <p id="time-display" class="text-4xl font-extrabold text-blue-900 mt-2"></p>
        <div class="scanner-container mt-4 mb-4">
          <video id="video"></video>
          <div id="loading-message">Loading camera...</div>
          <canvas id="canvas"></canvas>
        </div>
        <div id="status-box" class="p-4 rounded-lg text-sm transition-all duration-500 mb-4">
          <p id="status-message" class="font-semibold"></p>
        </div>
      </div>
    </div>

    <!-- Log -->
    <div id="log-tab" class="tab-content">
      <div class="rounded-card">
        <h2 class="text-2xl font-bold mb-4 text-blue-700">Attendance Log</h2>
        <div id="log-list" class="space-y-4"></div>
        <div class="flex gap-2">
          <button id="reset-button" class="w-1/2 mt-6 py-3 bg-red-500 text-white rounded-full">Clear Log</button>
          <button id="generate-report-button" class="w-1/2 mt-6 py-3 bg-blue-500 text-white rounded-full">Generate Report âœ¨</button>
        </div>
        <div id="report-container" class="mt-6">
          <h3 id="report-title" class="text-lg font-bold text-blue-700 mb-2 hidden">Attendance Report</h3>
          <div id="report-content" class="p-4 bg-gray-50 rounded-lg text-sm whitespace-pre-wrap"></div>
          <button id="copy-report-button" class="w-full mt-4 py-2 bg-gray-300 text-gray-800 rounded-full hidden">Copy Report</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div id="confirmation-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 h-full w-full">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
      <div class="mt-3 text-center">
        <h3 class="text-lg font-medium text-gray-900">Are you sure?</h3>
        <p class="text-sm text-gray-500 mt-2">This will clear all attendance records.</p>
        <div class="flex justify-center gap-2 mt-4">
          <button id="confirm-yes" class="px-4 py-2 bg-red-500 text-white rounded-md">Yes, Clear</button>
          <button id="confirm-no" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const video=document.getElementById('video'),canvas=document.getElementById('canvas'),context=canvas.getContext('2d');
    const loadingMessage=document.getElementById('loading-message'),statusBox=document.getElementById('status-box'),statusMessage=document.getElementById('status-message');
    const dateDisplay=document.getElementById('date-display'),timeDisplay=document.getElementById('time-display'),logList=document.getElementById('log-list');
    const resetButton=document.getElementById('reset-button'),scanTabBtn=document.getElementById('scan-tab-btn'),logTabBtn=document.getElementById('log-tab-btn');
    const scanTab=document.getElementById('scan-tab'),logTab=document.getElementById('log-tab');
    const generateReportButton=document.getElementById('generate-report-button'),reportContent=document.getElementById('report-content'),reportTitle=document.getElementById('report-title');
    const copyReportButton=document.getElementById('copy-report-button'),confirmationModal=document.getElementById('confirmation-modal');
    const confirmYesBtn=document.getElementById('confirm-yes'),confirmNoBtn=document.getElementById('confirm-no');

    const CLASS_START_HOUR=12,CLASS_START_MINUTE=0,LATE_THRESHOLD_MINUTES=5;

    // Tabs
    scanTabBtn.onclick=()=>{scanTab.classList.add('active');logTab.classList.remove('active');scanTabBtn.classList.add('button-active');logTabBtn.classList.remove('button-active');startCamera();};
    logTabBtn.onclick=()=>{logTab.classList.add('active');scanTab.classList.remove('active');logTabBtn.classList.add('button-active');scanTabBtn.classList.remove('button-active');stopCamera();displayLog();};

    // Time
    function updateDateTime(){const now=new Date();dateDisplay.textContent=now.toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'});timeDisplay.textContent=now.toLocaleTimeString('en-US');}
    setInterval(updateDateTime,1000);updateDateTime();

    // Camera
    function startCamera(){navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}}).then(stream=>{video.srcObject=stream;video.play();requestAnimationFrame(tick);loadingMessage.style.display='none';}).catch(()=>{loadingMessage.textContent='Camera unavailable';});}
    function stopCamera(){if(video.srcObject){video.srcObject.getTracks().forEach(t=>t.stop());video.srcObject=null;}}

    // Scan loop
    function tick(){if(video.readyState===video.HAVE_ENOUGH_DATA){canvas.height=video.videoHeight;canvas.width=video.videoWidth;context.drawImage(video,0,0,canvas.width,canvas.height);const img=context.getImageData(0,0,canvas.width,canvas.height);const code=jsQR(img.data,img.width,img.height,{inversionAttempts:"dontInvert"});if(code)processQRCode(code.data);}if(scanTab.classList.contains('active'))requestAnimationFrame(tick);}

    // Process QR
    function processQRCode(data){const parts=data.split(',');if(parts.length!==3){showMessage('Invalid QR code format','error');return;}
      const [studentName,studentId,studentCourse]=parts.map(p=>p.trim());const now=new Date();const today=now.toLocaleDateString();
      if(isStudentScannedToday(studentId,today)){showMessage('Already scanned today','warning');return;}
      let status='Present';const classStart=new Date(now);classStart.setHours(CLASS_START_HOUR,CLASS_START_MINUTE,0,0);const late=new Date(classStart);late.setMinutes(late.getMinutes()+LATE_THRESHOLD_MINUTES);
      if(now>late)status='Late';const record={name:studentName,id:studentId,course:studentCourse,time:now.toLocaleTimeString(),date:today,status};
      saveRecord(record);showMessage(`${studentName} marked as ${status}`,'success');}

    // Storage
    function getAttendanceLog(){return JSON.parse(localStorage.getItem('attendanceLog')||'[]');}
    function saveRecord(r){const log=getAttendanceLog();log.push(r);localStorage.setItem('attendanceLog',JSON.stringify(log));displayLog();}
    function isStudentScannedToday(id,date){return getAttendanceLog().some(r=>r.id===id&&r.date===date);}
    function displayLog(){const log=getAttendanceLog();logList.innerHTML=log.length?log.map(r=>`<div class="p-4 rounded-lg border"><p class="font-bold">${r.name}</p><p>ID: ${r.id}</p><p>Course: ${r.course}</p><p>Time: ${r.time}</p><p>Date: ${r.date}</p><span class="text-xs px-2 py-1 rounded-full ${r.status==='Present'?'bg-green-100 text-green-800':'bg-red-100 text-red-800'}">${r.status}</span></div>`).join(''):'<p class="text-center text-gray-500 italic">No records</p>'; }

    // Clear
    resetButton.onclick=()=>confirmationModal.classList.remove('hidden');
    confirmYesBtn.onclick=()=>{localStorage.removeItem('attendanceLog');displayLog();reportContent.textContent='';reportTitle.classList.add('hidden');copyReportButton.classList.add('hidden');confirmationModal.classList.add('hidden');showMessage('Log cleared','info');};
    confirmNoBtn.onclick=()=>confirmationModal.classList.add('hidden');

    // Report (OFFLINE)
    generateReportButton.onclick=()=>{const log=getAttendanceLog();if(!log.length){reportContent.textContent="No attendance records.";reportTitle.classList.remove('hidden');copyReportButton.classList.add('hidden');return;}
      const total=log.length,present=log.filter(r=>r.status==="Present").length,late=log.filter(r=>r.status==="Late").length;
      let txt=`Attendance Report\n\nTotal: ${total}\nPresent: ${present}\nLate: ${late}\n\nDetails:\n`;log.forEach((r,i)=>{txt+=`${i+1}. ${r.name} | ${r.course} | ${r.status}\n`;});
      reportContent.textContent=txt;reportTitle.classList.remove('hidden');copyReportButton.classList.remove('hidden');};
    copyReportButton.onclick=()=>{const ta=document.createElement('textarea');ta.value=reportContent.textContent;document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);showMessage("Report copied","success");};

    function showMessage(msg,type){statusMessage.textContent=msg;statusBox.className="p-4 rounded-lg text-sm mb-4";if(type==="success")statusBox.classList.add("bg-green-100","text-green-800");if(type==="warning")statusBox.classList.add("bg-yellow-100","text-yellow-800");if(type==="error")statusBox.classList.add("bg-red-100","text-red-800");if(type==="info")statusBox.classList.add("bg-blue-100","text-blue-800");}

    document.addEventListener('DOMContentLoaded',()=>{startCamera();displayLog();});
  </script>
</body>
</html>
